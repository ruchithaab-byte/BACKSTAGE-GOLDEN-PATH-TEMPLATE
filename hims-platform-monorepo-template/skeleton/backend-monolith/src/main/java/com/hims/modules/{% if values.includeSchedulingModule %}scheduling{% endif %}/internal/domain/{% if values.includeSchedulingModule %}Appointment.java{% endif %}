package com.hims.modules.scheduling.internal.domain;

import com.hims.core.tenant.TenantContext;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.hibernate.annotations.JdbcTypeCode;
import org.hibernate.type.SqlTypes;

import java.time.OffsetDateTime;
import java.util.UUID;

/**
 * Appointment Entity
 * 
 * Represents a patient appointment with a healthcare provider.
 * 
 * Pattern: Scheduling Module
 * - Appointment management (FHIR-aligned)
 * - Status tracking (proposed, booked, arrived, fulfilled, cancelled)
 * - Slot management
 * - Reminder tracking
 * - Check-in tracking
 * 
 * Critical for patient care coordination.
 */
@Entity
@Table(name = "appointments", schema = "scheduling")
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class Appointment {
    
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    @Column(name = "id", updatable = false, nullable = false)
    private UUID id;
    
    @Column(name = "tenant_id", nullable = false, updatable = false)
    private UUID tenantId;
    
    @Column(name = "created_at", nullable = false, updatable = false)
    @Builder.Default
    private OffsetDateTime createdAt = OffsetDateTime.now();
    
    @Column(name = "updated_at", nullable = false)
    @Builder.Default
    private OffsetDateTime updatedAt = OffsetDateTime.now();
    
    @Column(name = "created_by")
    private UUID createdBy;
    
    @Column(name = "updated_by")
    private UUID updatedBy;
    
    // ============================================================================
    // APPOINTMENT IDENTITY
    // ============================================================================
    @Column(name = "appointment_number", nullable = false, length = 50)
    private String appointmentNumber; // Unique appointment identifier
    
    @Column(name = "identifiers", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    @Builder.Default
    private Object identifiers = "[]"; // FHIR Identifier array
    
    // ============================================================================
    // STATUS & TYPE
    // ============================================================================
    @Column(name = "status", nullable = false, length = 50)
    @Builder.Default
    private String status = "proposed"; // "proposed", "pending", "booked", "arrived", "fulfilled", "cancelled", "noshow"
    
    @Column(name = "cancellation_reason", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    private Object cancellationReason; // FHIR CodeableConcept
    
    @Column(name = "service_category", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    @Builder.Default
    private Object serviceCategory = "[]"; // FHIR CodeableConcept array
    
    @Column(name = "service_type", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    @Builder.Default
    private Object serviceType = "[]"; // FHIR CodeableConcept array
    
    @Column(name = "specialty", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    @Builder.Default
    private Object specialty = "[]"; // FHIR CodeableConcept array
    
    @Column(name = "appointment_type", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    private Object appointmentType; // FHIR CodeableConcept
    
    // ============================================================================
    // TIMING
    // ============================================================================
    @Column(name = "start_time", nullable = false)
    private OffsetDateTime startTime; // Appointment start time
    
    @Column(name = "end_time", nullable = false)
    private OffsetDateTime endTime; // Appointment end time (must be > start_time)
    
    @Column(name = "duration_minutes")
    private Integer durationMinutes; // Calculated duration
    
    @Column(name = "slot_id")
    private UUID slotId; // FK to scheduling.slots(id)
    
    // ============================================================================
    // PARTICIPANTS
    // ============================================================================
    @Column(name = "patient_id", nullable = false)
    private UUID patientId; // Soft FK to clinical.patients(id)
    
    @Column(name = "practitioner_id")
    private UUID practitionerId; // Soft FK to clinical.practitioners(id)
    
    @Column(name = "location_id")
    private UUID locationId; // Soft FK to clinical.locations(id)
    
    @Column(name = "participants", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    @Builder.Default
    private Object participants = "[]"; // FHIR Participant array
    
    // ============================================================================
    // CLINICAL CONTEXT
    // ============================================================================
    @Column(name = "encounter_id")
    private UUID encounterId; // Soft FK to clinical.encounters(id)
    
    @Column(name = "reason_code", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    @Builder.Default
    private Object reasonCode = "[]"; // FHIR CodeableConcept array
    
    @Column(name = "reason_reference", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    @Builder.Default
    private Object reasonReference = "[]"; // FHIR Reference array
    
    @Column(name = "based_on", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    @Builder.Default
    private Object basedOn = "[]"; // FHIR Reference array
    
    // ============================================================================
    // DETAILS
    // ============================================================================
    @Column(name = "description", columnDefinition = "TEXT")
    private String description;
    
    @Column(name = "supporting_info", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    @Builder.Default
    private Object supportingInfo = "[]"; // FHIR Reference array
    
    @Column(name = "priority")
    @Builder.Default
    private Integer priority = 5; // 1-9, 5 = normal
    
    @Column(name = "comment", columnDefinition = "TEXT")
    private String comment;
    
    @Column(name = "patient_instruction", columnDefinition = "TEXT")
    private String patientInstruction;
    
    @Column(name = "patient_notes", columnDefinition = "TEXT")
    private String patientNotes;
    
    // ============================================================================
    // TRACKING
    // ============================================================================
    @Column(name = "booked_at")
    private OffsetDateTime bookedAt; // When appointment was booked
    
    @Column(name = "reminder_sent", nullable = false)
    @Builder.Default
    private Boolean reminderSent = false;
    
    @Column(name = "reminder_sent_at")
    private OffsetDateTime reminderSentAt;
    
    @Column(name = "checked_in_at")
    private OffsetDateTime checkedInAt; // Patient check-in time
    
    @Column(name = "checked_in_by")
    private UUID checkedInBy; // Soft FK to core.users(id)
    
    @Column(name = "billing_status", length = 50)
    private String billingStatus; // "pending", "billed", "paid"
    
    @Column(name = "requested_period", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    @Builder.Default
    private Object requestedPeriod = "[]"; // FHIR Period array
    
    @PrePersist
    protected void onCreate() {
        if (tenantId == null) {
            String tenantIdStr = TenantContext.getTenantId();
            if (tenantIdStr == null) {
                throw new IllegalStateException("Tenant context must be set");
            }
            tenantId = UUID.fromString(tenantIdStr);
        }
        if (createdAt == null) {
            createdAt = OffsetDateTime.now();
        }
        if (updatedAt == null) {
            updatedAt = OffsetDateTime.now();
        }
        if (bookedAt == null && "booked".equals(status)) {
            bookedAt = OffsetDateTime.now();
        }
        // Calculate duration
        if (startTime != null && endTime != null) {
            durationMinutes = (int) java.time.Duration.between(startTime, endTime).toMinutes();
        }
    }
    
    @PreUpdate
    protected void onUpdate() {
        updatedAt = OffsetDateTime.now();
        // Calculate duration
        if (startTime != null && endTime != null) {
            durationMinutes = (int) java.time.Duration.between(startTime, endTime).toMinutes();
        }
    }
}

