package com.hims.modules.documents.internal.domain;

import com.hims.core.tenant.TenantContext;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.hibernate.annotations.JdbcTypeCode;
import org.hibernate.type.SqlTypes;

import java.time.LocalDate;
import java.time.OffsetDateTime;
import java.util.List;
import java.util.UUID;

/**
 * Document Entity
 * 
 * Represents a document with version control, encryption, and compliance tracking.
 * 
 * Pattern: Documents Module
 * - Document management
 * - Version control
 * - Encryption support
 * - Virus scanning
 * - Compliance (DPDP/HIPAA)
 */
@Entity
@Table(name = "documents", schema = "documents")
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class Document {
    
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    @Column(name = "id", updatable = false, nullable = false)
    private UUID id;
    
    @Column(name = "tenant_id", nullable = false, updatable = false)
    private UUID tenantId;
    
    @Column(name = "created_at", nullable = false, updatable = false)
    @Builder.Default
    private OffsetDateTime createdAt = OffsetDateTime.now();
    
    @Column(name = "updated_at", nullable = false)
    @Builder.Default
    private OffsetDateTime updatedAt = OffsetDateTime.now();
    
    @Column(name = "created_by")
    private UUID createdBy;
    
    @Column(name = "updated_by")
    private UUID updatedBy;
    
    @Column(name = "document_number", nullable = false, length = 100)
    private String documentNumber;
    
    @Column(name = "document_type_id", nullable = false)
    private UUID documentTypeId;
    
    @Column(name = "document_type_code", nullable = false, length = 50)
    private String documentTypeCode;
    
    @Column(name = "title", nullable = false, length = 500)
    private String title;
    
    @Column(name = "description", columnDefinition = "TEXT")
    private String description;
    
    @Column(name = "owner_type", nullable = false, length = 50)
    private String ownerType; // "patient", "user", "encounter"
    
    @Column(name = "patient_id")
    private UUID patientId;
    
    @Column(name = "user_id")
    private UUID userId;
    
    @Column(name = "encounter_id")
    private UUID encounterId;
    
    @Column(name = "entity_type", length = 100)
    private String entityType;
    
    @Column(name = "entity_id")
    private UUID entityId;
    
    @Column(name = "original_filename", nullable = false, length = 500)
    private String originalFilename;
    
    @Column(name = "mime_type", nullable = false, length = 100)
    private String mimeType;
    
    @Column(name = "file_size_bytes", nullable = false)
    private Long fileSizeBytes;
    
    @Column(name = "file_extension", length = 20)
    private String fileExtension;
    
    @Column(name = "storage_provider", nullable = false, length = 50)
    @Builder.Default
    private String storageProvider = "s3";
    
    @Column(name = "storage_bucket", nullable = false, length = 255)
    private String storageBucket;
    
    @Column(name = "storage_key", nullable = false, length = 1000)
    private String storageKey;
    
    @Column(name = "storage_url", columnDefinition = "TEXT")
    private String storageUrl;
    
    @Column(name = "url_expires_at")
    private OffsetDateTime urlExpiresAt;
    
    @Column(name = "content_hash", length = 64)
    private String contentHash;
    
    @Column(name = "content_hash_algorithm", length = 20)
    @Builder.Default
    private String contentHashAlgorithm = "SHA256";
    
    @Column(name = "encryption_key_id")
    private UUID encryptionKeyId;
    
    @Column(name = "is_encrypted", nullable = false)
    @Builder.Default
    private Boolean isEncrypted = true;
    
    @Column(name = "virus_scan_status", length = 20)
    @Builder.Default
    private String virusScanStatus = "pending";
    
    @Column(name = "virus_scan_at")
    private OffsetDateTime virusScanAt;
    
    @Column(name = "virus_scan_result", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    private Object virusScanResult;
    
    @Column(name = "version_number", nullable = false)
    @Builder.Default
    private Integer versionNumber = 1;
    
    @Column(name = "is_latest_version", nullable = false)
    @Builder.Default
    private Boolean isLatestVersion = true;
    
    @Column(name = "parent_document_id")
    private UUID parentDocumentId;
    
    @Column(name = "status", nullable = false, length = 50)
    @Builder.Default
    private String status = "active";
    
    @Column(name = "metadata", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    @Builder.Default
    private Object metadata = "{}";
    
    @Column(name = "tags", columnDefinition = "TEXT[]")
    private List<String> tags;
    
    @Column(name = "data_sovereignty_tag", length = 50)
    @Builder.Default
    private String dataSovereigntyTag = "INDIA_LOCAL";
    
    @Column(name = "consent_ref")
    private UUID consentRef;
    
    @Column(name = "retention_until")
    private LocalDate retentionUntil;
    
    @Column(name = "archived_at")
    private OffsetDateTime archivedAt;
    
    @Column(name = "deleted_at")
    private OffsetDateTime deletedAt;
    
    @Column(name = "deletion_reason", columnDefinition = "TEXT")
    private String deletionReason;
    
    @PrePersist
    protected void onCreate() {
        if (tenantId == null) {
            String tenantIdStr = TenantContext.getTenantId();
            if (tenantIdStr == null) {
                throw new IllegalStateException("Tenant context must be set");
            }
            tenantId = UUID.fromString(tenantIdStr);
        }
        if (createdAt == null) {
            createdAt = OffsetDateTime.now();
        }
        if (updatedAt == null) {
            updatedAt = OffsetDateTime.now();
        }
    }
    
    @PreUpdate
    protected void onUpdate() {
        updatedAt = OffsetDateTime.now();
    }
}

