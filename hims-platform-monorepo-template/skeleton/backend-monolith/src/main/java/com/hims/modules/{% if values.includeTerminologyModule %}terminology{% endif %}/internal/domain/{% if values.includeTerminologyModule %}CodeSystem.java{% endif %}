package com.hims.modules.terminology.internal.domain;

import com.hims.core.tenant.TenantContext;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.hibernate.annotations.JdbcTypeCode;
import org.hibernate.type.SqlTypes;

import java.time.OffsetDateTime;
import java.util.UUID;

/**
 * Code System Entity
 * 
 * Represents a terminology code system (FHIR CodeSystem).
 * 
 * Pattern: Terminology Module
 * - Code system management
 * - Concept management
 * - Concept mapping
 */
@Entity
@Table(name = "code_systems", schema = "terminology")
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class CodeSystem {
    
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    @Column(name = "id", updatable = false, nullable = false)
    private UUID id;
    
    @Column(name = "tenant_id")
    private UUID tenantId;
    
    @Column(name = "url", nullable = false, length = 500)
    private String url;
    
    @Column(name = "identifier", nullable = false, length = 100)
    private String identifier;
    
    @Column(name = "version", nullable = false, length = 50)
    private String version;
    
    @Column(name = "name", nullable = false, length = 255)
    private String name;
    
    @Column(name = "title", length = 500)
    private String title;
    
    @Column(name = "publisher", length = 255)
    private String publisher;
    
    @Column(name = "copyright", columnDefinition = "TEXT")
    private String copyright;
    
    @Column(name = "status", length = 50)
    @Builder.Default
    private String status = "active";
    
    @Column(name = "experimental", nullable = false)
    @Builder.Default
    private Boolean experimental = false;
    
    @Column(name = "case_sensitive", nullable = false)
    @Builder.Default
    private Boolean caseSensitive = false;
    
    @Column(name = "value_set", length = 500)
    private String valueSet;
    
    @Column(name = "hierarchy_meaning", length = 50)
    private String hierarchyMeaning;
    
    @Column(name = "compositional", nullable = false)
    @Builder.Default
    private Boolean compositional = false;
    
    @Column(name = "version_needed", nullable = false)
    @Builder.Default
    private Boolean versionNeeded = false;
    
    @Column(name = "content", length = 50)
    @Builder.Default
    private String content = "complete";
    
    @Column(name = "count")
    private Integer count;
    
    @Column(name = "filters", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    @Builder.Default
    private Object filters = "[]";
    
    @Column(name = "properties", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    @Builder.Default
    private Object properties = "[]";
    
    @Column(name = "concepts", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    @Builder.Default
    private Object concepts = "[]";
    
    @Column(name = "supplements", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    @Builder.Default
    private Object supplements = "[]";
    
    @Column(name = "metadata", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    @Builder.Default
    private Object metadata = "{}";
    
    @Column(name = "last_updated")
    private OffsetDateTime lastUpdated;
    
    @Column(name = "created_at", nullable = false, updatable = false)
    @Builder.Default
    private OffsetDateTime createdAt = OffsetDateTime.now();
    
    @PrePersist
    protected void onCreate() {
        if (tenantId == null) {
            String tenantIdStr = TenantContext.getTenantId();
            if (tenantIdStr != null) {
                tenantId = UUID.fromString(tenantIdStr);
            }
        }
        if (createdAt == null) {
            createdAt = OffsetDateTime.now();
        }
    }
}

