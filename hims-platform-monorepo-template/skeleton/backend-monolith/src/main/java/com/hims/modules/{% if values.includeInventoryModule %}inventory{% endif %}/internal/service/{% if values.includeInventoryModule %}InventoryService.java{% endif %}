package com.hims.modules.inventory.internal.service;

import com.hims.core.audit.LogAudit;
import com.hims.core.events.EventPublisher;
import com.hims.core.events.EventMetadata;
import com.hims.core.tenant.TenantContext;
import com.hims.modules.inventory.api.spi.InventoryServiceProvider;
import com.hims.modules.inventory.internal.domain.InventoryItem;
import com.hims.modules.inventory.internal.repo.InventoryItemRepository;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Map;
import java.util.UUID;

/**
 * Service implementation for Inventory module.
 * 
 * Pattern: Inventory Module (FEFO + Batch Tracking)
 * - FEFO: First Expiry First Out sorting
 * - Batch tracking: Lot numbers, expiry dates
 * - Stock management: Current, minimum, maximum stock
 */
@Service
public class InventoryService implements InventoryServiceProvider {

    private final InventoryItemRepository repository;
    private final EventPublisher eventPublisher;

    public InventoryService(
            InventoryItemRepository repository,
            EventPublisher eventPublisher) {
        this.repository = repository;
        this.eventPublisher = eventPublisher;
    }

    /**
     * Get items by location, sorted by FEFO (First Expiry First Out).
     * 
     * Pattern: FEFO - Items with earliest expiry date are returned first.
     */
    @LogAudit(
        action = "GET_ITEMS_BY_FEFO",
        resourceType = "INVENTORY_ITEM",
        description = "Get inventory items sorted by FEFO"
    )
    public List<InventoryItem> getItemsByFefo(UUID locationId) {
        String tenantId = TenantContext.getTenantId();
        
        // FEFO: Sort by expiry date (earliest first)
        return repository.findItemsByLocationOrderedByExpiry(
            UUID.fromString(tenantId),
            locationId
        );
    }

    /**
     * Get item by batch number.
     * 
     * Pattern: Batch Tracking
     */
    @LogAudit(
        action = "GET_ITEM_BY_BATCH",
        resourceType = "INVENTORY_ITEM",
        description = "Get inventory item by batch number"
    )
    public InventoryItem getItemByBatchNumber(String batchNumber) {
        String tenantId = TenantContext.getTenantId();
        
        List<InventoryItem> items = repository.findByTenantIdAndBatchNumber(
            UUID.fromString(tenantId),
            batchNumber
        );
        
        return items.isEmpty() ? null : items.get(0);
    }

    /**
     * Example method showing Core Kernel integration.
     */
    @LogAudit(
        action = "CREATE_INVENTORY_ITEM",
        resourceType = "INVENTORY_ITEM",
        description = "Create inventory item"
    )
    public void createExample() {
        String tenantId = TenantContext.getTenantId();
        String userId = TenantContext.getUserId();
        
        // Placeholder - add actual business logic here
        
        // Publish event via Core Kernel
        eventPublisher.publish(
            "inventory.item.created",
            Map.of("id", "example-id"),
            EventMetadata.create()
                .withTenant(tenantId)
                .withUser(userId)
                .build()
        );
    }
}

