package com.hims.modules.scheduling.internal.repo;

import com.hims.modules.scheduling.internal.domain.Appointment;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.OffsetDateTime;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

/**
 * Repository for Appointment entity.
 * 
 * Pattern: Scheduling Module
 * - Appointment queries by status, date, practitioner, patient
 * - Slot availability queries
 */
@Repository
public interface AppointmentRepository extends JpaRepository<Appointment, UUID> {
    
    List<Appointment> findByTenantId(UUID tenantId);
    
    Optional<Appointment> findByTenantIdAndAppointmentNumber(UUID tenantId, String appointmentNumber);
    
    List<Appointment> findByTenantIdAndStatus(UUID tenantId, String status);
    
    List<Appointment> findByTenantIdAndPatientId(UUID tenantId, UUID patientId);
    
    List<Appointment> findByTenantIdAndPractitionerId(UUID tenantId, UUID practitionerId);
    
    @Query("SELECT a FROM Appointment a WHERE a.tenantId = :tenantId AND a.practitionerId = :practitionerId AND a.startTime >= :startTime AND a.endTime <= :endTime")
    List<Appointment> findByPractitionerAndDateRange(@Param("tenantId") UUID tenantId, @Param("practitionerId") UUID practitionerId, @Param("startTime") OffsetDateTime startTime, @Param("endTime") OffsetDateTime endTime);
    
    @Query("SELECT a FROM Appointment a WHERE a.tenantId = :tenantId AND a.status = 'booked' AND a.startTime >= :startTime AND a.startTime < :endTime")
    List<Appointment> findBookedAppointmentsInRange(@Param("tenantId") UUID tenantId, @Param("startTime") OffsetDateTime startTime, @Param("endTime") OffsetDateTime endTime);
}

