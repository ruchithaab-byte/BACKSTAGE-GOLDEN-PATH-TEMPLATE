package com.hims.modules.blood_bank.internal.domain;

import com.hims.core.tenant.TenantContext;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.hibernate.annotations.JdbcTypeCode;
import org.hibernate.type.SqlTypes;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.OffsetDateTime;
import java.util.List;
import java.util.UUID;

/**
 * Donor Entity
 * 
 * Represents a blood donor with complete medical history and eligibility tracking.
 * 
 * Pattern: Blood Bank Module
 * - Donor management (AABB standards)
 * - Eligibility tracking (deferral management)
 * - Medical history
 * - Donation history
 * - Hemoglobin tracking
 * 
 * Critical for donor safety and blood quality.
 */
@Entity
@Table(name = "donors", schema = "blood_bank")
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class Donor {
    
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    @Column(name = "id", updatable = false, nullable = false)
    private UUID id;
    
    @Column(name = "tenant_id", nullable = false, updatable = false)
    private UUID tenantId;
    
    @Column(name = "created_at", nullable = false, updatable = false)
    @Builder.Default
    private OffsetDateTime createdAt = OffsetDateTime.now();
    
    @Column(name = "updated_at", nullable = false)
    @Builder.Default
    private OffsetDateTime updatedAt = OffsetDateTime.now();
    
    @Column(name = "created_by")
    private UUID createdBy;
    
    // ============================================================================
    // DONOR IDENTITY
    // ============================================================================
    @Column(name = "donor_number", nullable = false, length = 50)
    private String donorNumber; // Unique donor identifier
    
    @Column(name = "name", nullable = false, length = 255)
    private String name;
    
    @Column(name = "date_of_birth")
    private LocalDate dateOfBirth;
    
    @Column(name = "gender", length = 20)
    private String gender; // FHIR gender enum: "male", "female", "other", "unknown"
    
    // ============================================================================
    // BLOOD GROUP
    // ============================================================================
    @Column(name = "blood_group", nullable = false, length = 10)
    private String bloodGroup; // "A+", "B-", "O+", "AB+", "A-", "B+", "O-", "AB-"
    
    @Column(name = "rh_factor", length = 5)
    private String rhFactor; // "+", "-"
    
    // ============================================================================
    // CONTACT INFORMATION
    // ============================================================================
    @Column(name = "phone", length = 50)
    private String phone;
    
    @Column(name = "email", length = 255)
    private String email;
    
    @Column(name = "address", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    private Object address; // FHIR Address structure
    
    // ============================================================================
    // MEDICAL HISTORY
    // ============================================================================
    @Column(name = "medical_history", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    @Builder.Default
    private Object medicalHistory = "[]"; // [{condition, date, resolved}]
    
    @Column(name = "medications", columnDefinition = "TEXT[]")
    private List<String> medications; // Current medications
    
    @Column(name = "allergies", columnDefinition = "TEXT[]")
    private List<String> allergies;
    
    // ============================================================================
    // DONATION HISTORY
    // ============================================================================
    @Column(name = "last_donation_date")
    private LocalDate lastDonationDate;
    
    @Column(name = "total_donations", nullable = false)
    @Builder.Default
    private Integer totalDonations = 0;
    
    @Column(name = "last_donation_id")
    private UUID lastDonationId; // Soft FK to blood_bank.blood_units(id)
    
    // ============================================================================
    // ELIGIBILITY TRACKING
    // ============================================================================
    @Column(name = "eligibility_status", nullable = false, length = 50)
    @Builder.Default
    private String eligibilityStatus = "eligible"; // "eligible", "deferred", "permanent_deferral"
    
    @Column(name = "deferral_reason", columnDefinition = "TEXT")
    private String deferralReason;
    
    @Column(name = "deferral_until_date")
    private LocalDate deferralUntilDate; // Temporary deferral end date
    
    // ============================================================================
    // PHYSICAL PARAMETERS
    // ============================================================================
    @Column(name = "weight_kg", precision = 5, scale = 2)
    private BigDecimal weightKg; // Weight in kilograms
    
    @Column(name = "last_hemoglobin_gdl", precision = 4, scale = 2)
    private BigDecimal lastHemoglobinGdl; // Last hemoglobin reading (g/dL)
    
    @Column(name = "last_hemoglobin_date")
    private LocalDate lastHemoglobinDate; // Date of last hemoglobin test
    
    // ============================================================================
    // STATUS
    // ============================================================================
    @Column(name = "is_active", nullable = false)
    @Builder.Default
    private Boolean isActive = true;
    
    @PrePersist
    protected void onCreate() {
        if (tenantId == null) {
            String tenantIdStr = TenantContext.getTenantId();
            if (tenantIdStr == null) {
                throw new IllegalStateException("Tenant context must be set");
            }
            tenantId = UUID.fromString(tenantIdStr);
        }
        if (createdAt == null) {
            createdAt = OffsetDateTime.now();
        }
        if (updatedAt == null) {
            updatedAt = OffsetDateTime.now();
        }
    }
    
    @PreUpdate
    protected void onUpdate() {
        updatedAt = OffsetDateTime.now();
    }
}

