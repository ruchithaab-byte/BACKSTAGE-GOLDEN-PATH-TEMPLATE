package com.hims.modules.communication.internal.domain;

import com.hims.core.tenant.TenantContext;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.hibernate.annotations.JdbcTypeCode;
import org.hibernate.type.SqlTypes;

import java.time.OffsetDateTime;
import java.util.UUID;

/**
 * Notification Entity
 * 
 * Represents a notification sent via various channels (SMS, Email, Push, etc.).
 * 
 * Pattern: Communication Module
 * - Multi-channel notifications
 * - Template-based messaging
 * - Delivery tracking
 * - Retry mechanism
 */
@Entity
@Table(name = "notifications", schema = "communication")
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class Notification {
    
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    @Column(name = "id", updatable = false, nullable = false)
    private UUID id;
    
    @Column(name = "tenant_id", nullable = false, updatable = false)
    private UUID tenantId;
    
    @Column(name = "created_at", nullable = false, updatable = false)
    @Builder.Default
    private OffsetDateTime createdAt = OffsetDateTime.now();
    
    @Column(name = "template_id")
    private UUID templateId;
    
    @Column(name = "template_code", length = 100)
    private String templateCode;
    
    @Column(name = "channel_type", nullable = false, length = 50)
    private String channelType; // "sms", "email", "push", "whatsapp", "voice"
    
    @Column(name = "recipient_type", nullable = false, length = 50)
    private String recipientType; // "patient", "user", "practitioner"
    
    @Column(name = "recipient_id", nullable = false)
    private UUID recipientId;
    
    @Column(name = "subject", length = 500)
    private String subject;
    
    @Column(name = "body_text", columnDefinition = "TEXT")
    private String bodyText;
    
    @Column(name = "body_html", columnDefinition = "TEXT")
    private String bodyHtml;
    
    @Column(name = "metadata", columnDefinition = "JSONB")
    @JdbcTypeCode(SqlTypes.JSON)
    @Builder.Default
    private Object metadata = "{}";
    
    @Column(name = "status", nullable = false, length = 50)
    @Builder.Default
    private String status = "pending"; // "pending", "sent", "delivered", "failed", "bounced"
    
    @Column(name = "sent_at")
    private OffsetDateTime sentAt;
    
    @Column(name = "delivered_at")
    private OffsetDateTime deliveredAt;
    
    @Column(name = "read_at")
    private OffsetDateTime readAt;
    
    @Column(name = "error_message", columnDefinition = "TEXT")
    private String errorMessage;
    
    @Column(name = "retry_count", nullable = false)
    @Builder.Default
    private Integer retryCount = 0;
    
    @PrePersist
    protected void onCreate() {
        if (tenantId == null) {
            String tenantIdStr = TenantContext.getTenantId();
            if (tenantIdStr == null) {
                throw new IllegalStateException("Tenant context must be set");
            }
            tenantId = UUID.fromString(tenantIdStr);
        }
        if (createdAt == null) {
            createdAt = OffsetDateTime.now();
        }
    }
}

