package com.hims.modules.laboratory.internal.service;

import com.hims.core.audit.LogAudit;
import com.hims.core.events.EventPublisher;
import com.hims.core.events.EventMetadata;
import com.hims.core.tenant.TenantContext;
import com.hims.modules.laboratory.api.spi.LaboratoryServiceProvider;
import com.hims.modules.laboratory.internal.domain.LaboratorySample;
import com.hims.modules.laboratory.internal.repo.LaboratorySampleRepository;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Map;
import java.util.UUID;

/**
 * Service implementation for Laboratory module.
 * 
 * Pattern: Laboratory Module (LIMS)
 * - Sample collection workflow
 * - QC tracking
 * - Machine interface
 */
@Service
public class LaboratoryService implements LaboratoryServiceProvider {

    private final LaboratorySampleRepository repository;
    private final EventPublisher eventPublisher;

    public LaboratoryService(
            LaboratorySampleRepository repository,
            EventPublisher eventPublisher) {
        this.repository = repository;
        this.eventPublisher = eventPublisher;
    }

    /**
     * Get sample by barcode.
     * 
     * Pattern: LIMS - Sample identification via barcode
     */
    @LogAudit(
        action = "GET_SAMPLE_BY_BARCODE",
        resourceType = "LABORATORY_SAMPLE",
        description = "Get laboratory sample by barcode"
    )
    public LaboratorySample getSampleByBarcode(String barcode) {
        String tenantId = TenantContext.getTenantId();
        
        List<LaboratorySample> samples = repository.findByTenantIdAndBarcode(
            UUID.fromString(tenantId),
            barcode
        );
        
        return samples.isEmpty() ? null : samples.get(0);
    }

    /**
     * Update QC status.
     * 
     * Pattern: LIMS - Quality Control tracking
     */
    @LogAudit(
        action = "UPDATE_QC_STATUS",
        resourceType = "LABORATORY_SAMPLE",
        description = "Update quality control status"
    )
    public void updateQcStatus(UUID sampleId, String status) {
        String tenantId = TenantContext.getTenantId();
        String userId = TenantContext.getUserId();
        
        LaboratorySample sample = repository.findById(sampleId)
            .orElseThrow(() -> new IllegalArgumentException("Sample not found"));
        
        // Update QC status
        sample.setQualityStatus(status);
        repository.save(sample);
        
        // Publish event
        eventPublisher.publish(
            "laboratory.sample.qc.updated",
            Map.of("sampleId", sampleId.toString(), "status", status),
            EventMetadata.create()
                .withTenant(tenantId)
                .withUser(userId)
                .build()
        );
    }

    /**
     * Example method showing Core Kernel integration.
     */
    @LogAudit(
        action = "CREATE_LABORATORY_SAMPLE",
        resourceType = "LABORATORY_SAMPLE",
        description = "Create laboratory sample"
    )
    public void createExample() {
        String tenantId = TenantContext.getTenantId();
        String userId = TenantContext.getUserId();
        
        // Placeholder - add actual business logic here
        
        // Publish event via Core Kernel
        eventPublisher.publish(
            "laboratory.sample.created",
            Map.of("id", "example-id"),
            EventMetadata.create()
                .withTenant(tenantId)
                .withUser(userId)
                .build()
        );
    }
}

