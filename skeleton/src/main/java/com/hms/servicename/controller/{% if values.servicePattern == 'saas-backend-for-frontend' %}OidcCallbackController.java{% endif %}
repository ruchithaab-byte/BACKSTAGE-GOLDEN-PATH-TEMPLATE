package com.hms.servicename.controller;

import com.scalekit.ScalekitClient;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import java.io.IOException;

@RestController
public class OidcCallbackController {

    private static final Logger log = LoggerFactory.getLogger(OidcCallbackController.class);

    @Autowired
    private ScalekitClient scalekitClient;

    @Autowired
    private com.hms.{{ values.serviceName | replace("-", "") }}.service.{{ values.serviceName | replace("-", "") | capitalize }}UserManagementService userManagementService;

    /**
     * Custom OIDC callback handler.
     * This endpoint receives the authorization code from ScaleKit after user login.
     */
    @GetMapping("/api/callback")
    public void handleCallback(
            @RequestParam("code") String code,
            @RequestParam(value = "state", required = false) String state,
            HttpServletRequest request,
            HttpServletResponse response) throws IOException {
        
        try {
            // 1. Exchange code for tokens (Example - actual implementation depends on ScaleKit SDK usage)
            // var tokenResponse = scalekitClient.authentication().authenticateWithCode(code, redirectUri);
            
            // 2. Extract user info
            // var user = tokenResponse.getUser();
            
            // 3. JIT Provisioning
            // userManagementService.createUser(user.getEmail(), user.getFirstName(), user.getLastName(), "default-org-id");
            
            // 4. Create Session
            // request.getSession().setAttribute("user", user);
            
            log.info("OIDC Callback handled successfully");
            response.sendRedirect("/");
            
        } catch (Exception e) {
            log.error("OIDC Callback failed", e);
            response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR, "Login failed");
        }
    }
}

